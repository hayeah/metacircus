<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>
     
       Proc.new And Lambda Are Only 99.9% the Same - Howard Yeh | Metacircus
     
   </title>
   <meta name="author" content="Howard Yeh" />
   
   <link href="http://feeds2.feedburner.com/metacircus" rel="alternate" title="Metacircus" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />
</head>
<body>

<div class="site">
  <div class="title">
    <h1><a href="/">Metacircus <span class="name"> by Howard Yeh </span></a></h1>
    <h2 class="meta">Words Are But Shattered Mirror of Thoughts</h2>
  </div>

  <div class="main">
    <div id="post">
  <h1 class='post-title'>Proc.new And Lambda Are Only 99.9% the Same</h1>
<p>Proc.new And Lambda Are Only 99.9% the Same. Which is to say, not at all the same. 99.9% of the time it&#8217;s ok to use lambda, proc, and Proc.new interchangeably. So I do (shame on me).</p>

<p>I prefer using lambda when I am doing functional style programming in Ruby, passing around many closures, because the syntax is less chunky than Proc.new. Trivial preference that shouldn&#8217;t matter.</p>

<p>Except that it does. And it hurts a lot when it does.</p>

<p>Most of the time I get away with it&#8230; but Chinese has a lovely saying, a moral admonition, that &#8220;the more you walk the dark road, the more ghouls you <em>will</em> see.&#8221; So sooner or later I am bound to run into an edge case that makes my code to behave in unexpected ways.</p>

<p>This kind of bugs are especially insidious, since I&#8217;ve been conditioned (or, I&#8217;ve conditioned myself) to think that Proc.new and Lambda are the same. On some level I know they are different, of course, but I am so used to using them interchangeably, that there&#8217;s a lacuna in my vision that makes it hard to suspect the problem could arise from using Lambda instead of Proc.new, or vice versa.</p>

<p>I had a recent bug that boils down to this:</p>

<pre><code>def test1
  yield([1,2])
end

def test2(&amp;block)
  block.call([1,2])
end

pr = Proc.new { |(a,b)| [a,b] }
fn = lambda { |(a,b)| [a,b] }
p test1(&amp;pr) # =&gt; [1,2]
p test1(&amp;fn) # =&gt; [1,2]
p test2(&amp;pr) # =&gt; [1,2]
p test2(&amp;fn) # =&gt; wrong number of arguments (1 for 2) (ArgumentError)</code></pre>

<p>Why doesn&#8217;t it work? It turns out that lambda is stricter than block about the argument list. The arity for both <code>fn</code> and <code>pr</code> is actually two. While a lambda complains, a Proc.new magically takes apart the array argument.</p>

<p>The weird part is, <code>fn</code> and <code>pr</code> behave the same way if they are <code>yield</code>ed to, but not when they are being <code>block.call</code>ed. Yay for random Ruby esoteric trivia.</p>

<p><em>Bonus round</em>. We know that the <code>return</code> keyword returns from lambda, regardless of where lambda closure was created (unlike Proc.new, for which <code>return</code> always return from the method context where the Proc.new closure was created). But&#8230;</p>

<pre><code>def test1(&amp;block)
  block.call
end

test1(&amp;lambda { return }) # ok

def test2
  yield
end

test2(&amp;lambda { return }) # unexpected return (LocalJumpError)</code></pre>

<p>In this case, the return preserves its semantic if called via <code>block.call</code>, but not when <code>yield</code>ed, exactly the opposite as in the previous case. Pretty weird huh? That&#8217;ll be on Thursday&#8217;s quiz.</p>

<p>Now, for a trick question.</p>

<pre><code>b = Proc.new { |(a,b)| [a,b] }
b.call(1,2) # ok
b.call(3,4) # fails</code></pre>

<p>Why does it fail? Hint, it&#8217;s fixed in Ruby1.9. And this bug I actually ran into in production code. It was not as balatant as this example, and involves indeterminism introduced by threads. So that was a lot of fun in the painful sense of the word, in the butt.</p>

<p>The moral of the story is that the Python Zen, TOOWTDI (There&#8217;s Only One Way To Do It), is a sage advice. But Ruby isn&#8217;t Python, as there are many ways to chunkify a bacon. So the responsibility is on us individually. If there&#8217;s no compelling reason to use one approach over the other, <em>always</em> (*) go with the same default.</p>

<p>(*) Confession: for a while, I only used <code>if</code>, and never <code>unless</code>. Srly. I&#8217;ve since given that up. This is a good example of Poe&#8217;s Law, &#8220;Without a winking smiley or other blatant display of humor, it is impossible to create a parody of Fundamentalism that SOMEONE won&#8217;t mistake for the real thing.&#8221;</p>
  <div id="sharebox">
    <a href="http://twitter.com/share" class="twitter-share-button" data-text="Proc.new And Lambda Are Only 99.9% the Same" data-count="vertical" data-via="hayeah">Tweet</a>
  </div>

  <p class="followme">
    If you like my writing you should follow me on <a href="http://twitter.com/hayeah">Twitter</a>.
  </p>
</div>


<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

<div id="comments">
  <a href="http://www.metacircus.com/hacking/2010/04/13/Proc-new-and-lambda-are-only.html#disqus_thread">Comments</a>
  <div id="disqus_thread"></div>
  <script type="text/javascript" src="http://disqus.com/forums/metacircus/embed.js"></script>
  <noscript><a href="http://metacircus.disqus.com/?url=ref">View the discussion thread.</a></noscript>
</div>

  </div>

  <div class="sidebar">
    
      <div id="about" class="section">
        <h2>About Me</h2>
        <img title="Howard Yeh's Likeness" alt="Howard Yeh's Likeness" src="/images/howard-yeh.jpg"></img>
        <p><b>Howard Yeh</b>. Thinker. Traveller. Entrepreneur. Hacker. Violinist. </p>
        <p>
          Howard is a Rails freelancer. He is now travelling the world, spending
          less money than staying at home. After 6 months of travel, he saved more
          money in the bank than when he started. Everything he owns fits in a 25L
          backpack.
          <a href="/about_howard_yeh.html">More</a>
        </p>
        <p class="follow">
          <em>
            You should <a href="http://twitter.com/hayeah"><b>follow me</b></a>
            around the world.
          </em>
        </p>
      </div>
    

    <div id="subscribe" class="section links">
      <h3><img src="/images/feed-icon16x16.png"/>Subscribe</h3>
      <a href="http://feeds2.feedburner.com/metacircus">Via RSS feed</a>
      <a href="http://feedburner.google.com/fb/a/mailverify?uri=metacircus&amp;loc=en_US">Get updates by email</a>
    </div>

    <div id="contact" class="section links">
      <h3>Contact Me</h3>
      <a href="mailto:hayeah@gmail.com">hayeah@gmail.com</a>
      <a href="http://twitter.com/hayeah">Follow me on <img src="/images/twitter.png"/> Twitter</a>
    </div>
    
  </div>
  <div class="clear"></div>
  <div class="footer">
    <div class="contact">
      <p>
        <b>Howard Yeh</b>
        <br/>
        <a href="mailto:hayeah@gmail.com">hayeah@gmail.com</a>
        <br/>
        <a href="http://twitter.com/hayeah"><b>@hayeah</b></a>
      </p>
    </div>
  </div>
</div>

<!-- GetClicky -->
<script type="text/javascript">
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(66479153);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
</script>

<!-- Google Analytics -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-7576362-1");
pageTracker._trackPageview();
} catch(err) {}</script>

<!-- Disqus -->
<script type="text/javascript">
//<![CDATA[
(function() {
		var links = document.getElementsByTagName('a');
		var query = '?';
		for(var i = 0; i < links.length; i++) {
			if(links[i].href.indexOf('#disqus_thread') >= 0) {
				query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
			}
		}
		document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/metacircus/get_num_replies.js' + query + '"></' + 'script>');
	})();
//]]>
</script>
</body>
</html>
